From: =?UTF-8?q?Mika=20Pfl=C3=BCger?= <debian@mikapflueger.de>
Date: Mon, 27 Feb 2012 01:22:42 +0100
Subject: Droppable legacy patch (differs from newer upstream only in
 syntax/whitespace)

---
 policy/modules/kernel/devices.fc    |   15 +++++++--------
 policy/modules/services/dkim.if     |   19 +++++++++++++++++++
 policy/modules/services/dkim.te     |    6 ++++++
 policy/modules/services/dovecot.fc  |   14 +++++++++++---
 policy/modules/services/dovecot.te  |   24 +++++++++++++++++++++++-
 policy/modules/services/xserver.fc  |   27 +++++++++++++--------------
 policy/modules/system/sysnetwork.fc |   10 +++-------
 policy/modules/system/udev.fc       |   14 ++++----------
 policy/modules/system/unconfined.fc |   12 +++---------
 9 files changed, 89 insertions(+), 52 deletions(-)

diff --git a/policy/modules/kernel/devices.fc b/policy/modules/kernel/devices.fc
index 02b7ac1..bcf07ba 100644
--- a/policy/modules/kernel/devices.fc
+++ b/policy/modules/kernel/devices.fc
@@ -1,5 +1,12 @@
 
 /dev			-d	gen_context(system_u:object_r:device_t,s0)
+ifdef(`distro_debian',`
+# this is a static /dev dir "backup mount"
+# if you want to disable udev, you'll have to boot permissive and relabel!
+/dev/\.static	-d		gen_context(system_u:object_r:device_t,s0)
+/dev/\.static/dev	-d		gen_context(system_u:object_r:device_t,s0)
+/dev/\.static/dev/(.*)?		<<none>>
+')
 /dev/.*				gen_context(system_u:object_r:device_t,s0)
 
 /dev/.*mouse.*		-c	gen_context(system_u:object_r:mouse_device_t,s0)
@@ -179,14 +186,6 @@ ifdef(`distro_suse', `
 /dev/xen/gntdev		-c	gen_context(system_u:object_r:xen_device_t,s0)
 /dev/xen/gntalloc	-c	gen_context(system_u:object_r:xen_device_t,s0)
 
-ifdef(`distro_debian',`
-# this is a static /dev dir "backup mount"
-# if you want to disable udev, you'll have to boot permissive and relabel!
-/dev/\.static		-d	gen_context(system_u:object_r:device_t,s0)
-/dev/\.static/dev	-d	gen_context(system_u:object_r:device_t,s0)
-/dev/\.static/dev/(.*)?		<<none>>
-')
-
 /etc/udev/devices	-d	gen_context(system_u:object_r:device_t,s0)
 
 # used by init scripts to initally populate udev /dev
diff --git a/policy/modules/services/dkim.if b/policy/modules/services/dkim.if
index 32d108a..ded8d21 100644
--- a/policy/modules/services/dkim.if
+++ b/policy/modules/services/dkim.if
@@ -1 +1,20 @@
 ## <summary>DomainKeys Identified Mail milter.</summary>
+
+########################################
+## <summary>
+##      Connect to dkim-milter.
+## </summary>
+## <param name="domain">
+##      <summary>
+##      Domain allowed to connect.
+##      </summary>
+## </param>
+#
+interface(`dkim_stream_connect',`
+	gen_require(`
+		type dkim_milter_t, dkim_milter_data_t;
+	')
+
+	stream_connect_pattern($1,dkim_milter_data_t,dkim_milter_data_t,dkim_milter_t)
+')
+
diff --git a/policy/modules/services/dkim.te b/policy/modules/services/dkim.te
index 1b4983d..ccd2f7a 100644
--- a/policy/modules/services/dkim.te
+++ b/policy/modules/services/dkim.te
@@ -11,12 +11,18 @@ milter_template(dkim)
 type dkim_milter_private_key_t;
 files_type(dkim_milter_private_key_t)
 
+type dkim_milter_tmp_t;
+files_tmp_file(dkim_milter_tmp_t)
+ubac_constrained(dkim_milter_tmp_t)
+files_tmp_filetrans(dkim_milter_t, dkim_milter_tmp_t, file)
+
 ########################################
 #
 # Local policy
 #
 
 allow dkim_milter_t self:capability { setgid setuid };
+kernel_read_system_state(dkim_milter_t)
 
 read_files_pattern(dkim_milter_t, dkim_milter_private_key_t, dkim_milter_private_key_t)
 
diff --git a/policy/modules/services/dovecot.fc b/policy/modules/services/dovecot.fc
index bfc880b..54fd83a 100644
--- a/policy/modules/services/dovecot.fc
+++ b/policy/modules/services/dovecot.fc
@@ -9,6 +9,12 @@
 /etc/pki/dovecot(/.*)?			gen_context(system_u:object_r:dovecot_cert_t,s0)
 /etc/rc\.d/init\.d/dovecot	--	gen_context(system_u:object_r:dovecot_initrc_exec_t,s0)
 
+# Debian uses /etc/dovecot/
+ifdef(`distro_debian', `
+/etc/dovecot(/.*)?                     gen_context(system_u:object_r:dovecot_etc_t,s0)
+/etc/dovecot/passwd.*                  gen_context(system_u:object_r:dovecot_passwd_t,s0)
+')
+
 #
 # /usr
 #
@@ -18,8 +24,7 @@
 /usr/share/ssl/private/dovecot\.pem --	gen_context(system_u:object_r:dovecot_cert_t,s0)
 
 ifdef(`distro_debian', `
-/usr/lib/dovecot/dovecot-auth	--	gen_context(system_u:object_r:dovecot_auth_exec_t,s0)
-/usr/lib/dovecot/deliver	--	gen_context(system_u:object_r:dovecot_deliver_exec_t,s0)
+/usr/lib/dovecot/dovecot-auth 	--	gen_context(system_u:object_r:dovecot_auth_exec_t,s0)
 ')
 
 ifdef(`distro_redhat', `
@@ -33,7 +38,10 @@ ifdef(`distro_redhat', `
 # /var
 #
 /var/run/dovecot(-login)?(/.*)?		gen_context(system_u:object_r:dovecot_var_run_t,s0)
-/var/run/dovecot/login/ssl-parameters.dat -- gen_context(system_u:object_r:dovecot_var_lib_t,s0)
+ifdef(`distro_redhat', `
+# this is a hard link to /var/lib/dovecot/ssl-parameters.dat
+/var/run/dovecot/login/ssl-parameters.dat	gen_context(system_u:object_r:dovecot_var_lib_t,s0)
+')
 
 /var/lib/dovecot(/.*)?			gen_context(system_u:object_r:dovecot_var_lib_t,s0)
 
diff --git a/policy/modules/services/dovecot.te b/policy/modules/services/dovecot.te
index bc04813..4a9ae02 100644
--- a/policy/modules/services/dovecot.te
+++ b/policy/modules/services/dovecot.te
@@ -20,11 +20,13 @@ files_tmp_file(dovecot_auth_tmp_t)
 type dovecot_cert_t;
 files_type(dovecot_cert_t)
 
+ifdef(`distro_redhat', `
 type dovecot_deliver_t;
 type dovecot_deliver_exec_t;
 domain_type(dovecot_deliver_t)
 domain_entry_file(dovecot_deliver_t, dovecot_deliver_exec_t)
 role system_r types dovecot_deliver_t;
+')
 
 type dovecot_etc_t;
 files_config_file(dovecot_etc_t)
@@ -72,6 +74,7 @@ allow dovecot_t dovecot_cert_t:dir list_dir_perms;
 read_files_pattern(dovecot_t, dovecot_cert_t, dovecot_cert_t)
 read_lnk_files_pattern(dovecot_t, dovecot_cert_t, dovecot_cert_t)
 
+allow dovecot_t dovecot_etc_t:dir list_dir_perms;
 allow dovecot_t dovecot_etc_t:file read_file_perms;
 files_search_etc(dovecot_t)
 
@@ -180,6 +183,10 @@ optional_policy(`
 # dovecot auth local policy
 #
 
+logging_search_logs(dovecot_auth_t)
+allow dovecot_auth_t dovecot_etc_t:dir list_dir_perms;
+allow dovecot_auth_t dovecot_etc_t:file read_file_perms;
+manage_sock_files_pattern(dovecot_auth_t,dovecot_var_run_t,dovecot_var_run_t)
 allow dovecot_auth_t self:capability { chown dac_override setgid setuid };
 allow dovecot_auth_t self:process { signal_perms getcap setcap };
 allow dovecot_auth_t self:fifo_file rw_fifo_file_perms;
@@ -236,6 +243,8 @@ optional_policy(`
 optional_policy(`
 	mysql_search_db(dovecot_auth_t)
 	mysql_stream_connect(dovecot_auth_t)
+	mysql_tcp_connect(dovecot_auth_t)
+	mysql_read_config(dovecot_auth_t)
 ')
 
 optional_policy(`
@@ -250,10 +259,12 @@ optional_policy(`
 #
 # dovecot deliver local policy
 #
+ifdef(`distro_redhat', `
 allow dovecot_deliver_t self:unix_dgram_socket create_socket_perms;
 
 allow dovecot_deliver_t dovecot_t:process signull;
 
+allow dovecot_deliver_t dovecot_etc_t:dir list_dir_perms;
 allow dovecot_deliver_t dovecot_etc_t:file read_file_perms;
 allow dovecot_deliver_t dovecot_var_run_t:dir list_dir_perms;
 
@@ -266,7 +277,6 @@ files_read_etc_runtime_files(dovecot_deliver_t)
 auth_use_nsswitch(dovecot_deliver_t)
 
 logging_send_syslog_msg(dovecot_deliver_t)
-logging_search_logs(dovecot_auth_t)
 
 miscfiles_read_localization(dovecot_deliver_t)
 
@@ -304,3 +314,15 @@ tunable_policy(`use_samba_home_dirs',`
 optional_policy(`
 	mta_manage_spool(dovecot_deliver_t)
 ')
+# end ifdef distro_redhat
+')
+
+optional_policy(`
+       mysql_tcp_connect(dovecot_auth_t)
+       mysql_stream_connect(dovecot_auth_t)
+')
+
+optional_policy(`
+       postgresql_tcp_connect(dovecot_auth_t)
+       postgresql_stream_connect(dovecot_auth_t)
+')
diff --git a/policy/modules/services/xserver.fc b/policy/modules/services/xserver.fc
index 829fd44..47d64a8 100644
--- a/policy/modules/services/xserver.fc
+++ b/policy/modules/services/xserver.fc
@@ -18,15 +18,12 @@ HOME_DIR/\.Xauthority.*	--	gen_context(system_u:object_r:xauth_home_t,s0)
 #
 # /etc
 #
-/etc/gdm/PostSession/.*	--	gen_context(system_u:object_r:xsession_exec_t,s0)
-/etc/gdm/PreSession/.*	--	gen_context(system_u:object_r:xsession_exec_t,s0)
-/etc/gdm/Xsession	--	gen_context(system_u:object_r:xsession_exec_t,s0)
 
 /etc/init\.d/xfree86-common --	gen_context(system_u:object_r:xserver_exec_t,s0)
 
-/etc/kde[34]?/kdm/Xstartup --	gen_context(system_u:object_r:xsession_exec_t,s0)
-/etc/kde[34]?/kdm/Xreset --	gen_context(system_u:object_r:xsession_exec_t,s0)
-/etc/kde[34]?/kdm/Xsession --	gen_context(system_u:object_r:xsession_exec_t,s0)
+/etc/kde[34]?/kdm/Xstartup	--	gen_context(system_u:object_r:xsession_exec_t,s0)
+/etc/kde[34]?/kdm/Xreset	--	gen_context(system_u:object_r:xsession_exec_t,s0)
+/etc/kde[34]?/kdm/Xsession	--	gen_context(system_u:object_r:xsession_exec_t,s0)
 /etc/kde[34]?/kdm/backgroundrc	gen_context(system_u:object_r:xdm_var_run_t,s0)
 
 /etc/X11/[wx]dm/Xreset.* --	gen_context(system_u:object_r:xsession_exec_t,s0)
@@ -36,6 +33,10 @@ HOME_DIR/\.Xauthority.*	--	gen_context(system_u:object_r:xauth_home_t,s0)
 /etc/X11/wdm/Xstartup.*	--	gen_context(system_u:object_r:xsession_exec_t,s0)
 /etc/X11/Xsession[^/]*	--	gen_context(system_u:object_r:xsession_exec_t,s0)
 
+/etc/gdm/Xsession	--	gen_context(system_u:object_r:xsession_exec_t,s0)
+/etc/gdm/PostSession/.*	--	gen_context(system_u:object_r:xsession_exec_t,s0)
+/etc/gdm/PreSession/.*	--	gen_context(system_u:object_r:xsession_exec_t,s0)
+
 #
 # /opt
 #
@@ -66,6 +67,10 @@ HOME_DIR/\.Xauthority.*	--	gen_context(system_u:object_r:xauth_home_t,s0)
 
 /usr/lib(64)?/qt-.*/etc/settings(/.*)?	gen_context(system_u:object_r:xdm_var_run_t,s0)
 
+ifndef(`distro_debian', `
+/usr/var/[xgkw]dm(/.*)?		gen_context(system_u:object_r:xserver_log_t,s0)
+')
+
 /usr/X11R6/bin/[xgkw]dm	--	gen_context(system_u:object_r:xdm_exec_t,s0)
 /usr/X11R6/bin/iceauth	--	gen_context(system_u:object_r:iceauth_exec_t,s0)
 /usr/X11R6/bin/X	--	gen_context(system_u:object_r:xserver_exec_t,s0)
@@ -77,17 +82,11 @@ HOME_DIR/\.Xauthority.*	--	gen_context(system_u:object_r:xauth_home_t,s0)
 /usr/X11R6/lib/X11/xkb	-d	gen_context(system_u:object_r:xkb_var_lib_t,s0)
 /usr/X11R6/lib/X11/xkb/.* --	gen_context(system_u:object_r:xkb_var_lib_t,s0)
 
-ifndef(`distro_debian',`
-/usr/var/[xgkw]dm(/.*)?		gen_context(system_u:object_r:xserver_log_t,s0)
-')
-
 #
 # /var
 #
 
-/var/[xgkw]dm(/.*)?		gen_context(system_u:object_r:xserver_log_t,s0)
-
-/var/lib/[xkw]dm(/.*)?		gen_context(system_u:object_r:xdm_var_lib_t,s0)
+/var/lib/[xgkw]dm(/.*)?		gen_context(system_u:object_r:xdm_var_lib_t,s0)
 /var/lib/xkb(/.*)?		gen_context(system_u:object_r:xkb_var_lib_t,s0)
 
 /var/log/[kw]dm\.log.*	--	gen_context(system_u:object_r:xserver_log_t,s0)
@@ -96,8 +95,8 @@ ifndef(`distro_debian',`
 /var/log/Xorg.*		--	gen_context(system_u:object_r:xserver_log_t,s0)
 
 /var/run/[gx]dm\.pid	--	gen_context(system_u:object_r:xdm_var_run_t,s0)
-/var/run/xauth(/.*)?		gen_context(system_u:object_r:xdm_var_run_t,s0)
 /var/run/xdmctl(/.*)?		gen_context(system_u:object_r:xdm_var_run_t,s0)
+/var/run/xauth(/.*)?		gen_context(system_u:object_r:xdm_var_run_t,s0)
 
 ifdef(`distro_suse',`
 /var/lib/pam_devperm/:0	--	gen_context(system_u:object_r:xdm_var_lib_t,s0)
diff --git a/policy/modules/system/sysnetwork.fc b/policy/modules/system/sysnetwork.fc
index 11009a5..386cbeb 100644
--- a/policy/modules/system/sysnetwork.fc
+++ b/policy/modules/system/sysnetwork.fc
@@ -5,13 +5,6 @@
 /bin/ip			--	gen_context(system_u:object_r:ifconfig_exec_t,s0)
 
 #
-# /dev
-#
-ifdef(`distro_debian',`
-/dev/shm/network(/.*)?		gen_context(system_u:object_r:net_conf_t,s0)
-')
-
-#
 # /etc
 #
 /etc/dhclient.*conf	--	gen_context(system_u:object_r:dhcp_etc_t,s0)
@@ -35,6 +28,9 @@ ifdef(`distro_redhat',`
 /etc/sysconfig/network-scripts(/.*)? gen_context(system_u:object_r:net_conf_t,s0)
 ')
 
+ifdef(`distro_debian', `
+/dev/shm/network(/.*)?			gen_context(system_u:object_r:net_conf_t,s0)
+')
 #
 # /sbin
 #
diff --git a/policy/modules/system/udev.fc b/policy/modules/system/udev.fc
index 2575393..6776684 100644
--- a/policy/modules/system/udev.fc
+++ b/policy/modules/system/udev.fc
@@ -11,10 +11,12 @@
 
 /lib/udev/udev-acl --	gen_context(system_u:object_r:udev_exec_t,s0)
 
-ifdef(`distro_debian',`
+ifdef(`distro_debian', `
 /lib/udev/create_static_nodes -- gen_context(system_u:object_r:udev_exec_t,s0)
+/var/run/xen-hotplug -d gen_context(system_u:object_r:udev_var_run_t,s0)
+', `
+/sbin/start_udev --	gen_context(system_u:object_r:udev_exec_t,s0)
 ')
-
 /sbin/udev	--	gen_context(system_u:object_r:udev_exec_t,s0)
 /sbin/udevadm	--	gen_context(system_u:object_r:udev_exec_t,s0)
 /sbin/udevd	--	gen_context(system_u:object_r:udev_exec_t,s0)
@@ -22,15 +24,7 @@ ifdef(`distro_debian',`
 /sbin/udevstart	--	gen_context(system_u:object_r:udev_exec_t,s0)
 /sbin/wait_for_sysfs -- gen_context(system_u:object_r:udev_exec_t,s0)
 
-ifdef(`distro_redhat',`
-/sbin/start_udev --	gen_context(system_u:object_r:udev_exec_t,s0)
-')
-
 /usr/bin/udevinfo --	gen_context(system_u:object_r:udev_exec_t,s0)
 
 /var/run/PackageKit/udev(/.*)? gen_context(system_u:object_r:udev_var_run_t,s0)
 /var/run/udev(/.*)?	gen_context(system_u:object_r:udev_tbl_t,s0)
-
-ifdef(`distro_debian',`
-/var/run/xen-hotplug -d	gen_context(system_u:object_r:udev_var_run_t,s0)
-')
diff --git a/policy/modules/system/unconfined.fc b/policy/modules/system/unconfined.fc
index 4902c11..2c4e50d 100644
--- a/policy/modules/system/unconfined.fc
+++ b/policy/modules/system/unconfined.fc
@@ -1,7 +1,4 @@
 # Add programs here which should not be confined by SELinux
-# e.g.:
-# /usr/local/bin/appsrv		--	gen_context(system_u:object_r:unconfined_exec_t,s0)
-# For the time being until someone writes a sane policy, we need initrc to transition to unconfined_t
 /usr/bin/valgrind 		--	gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
 /usr/bin/vncserver		--	gen_context(system_u:object_r:unconfined_exec_t,s0)
 
@@ -9,12 +6,9 @@
 /usr/lib/openoffice\.org.*/program/.+\.bin -- gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
 
 /usr/local/RealPlayer/realplay\.bin --	gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
-
-ifdef(`distro_debian',`
-/usr/bin/gcj-dbtool-4\.1	--	gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
-/usr/bin/gij-4\.1		--	gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
-/usr/lib/openoffice/program/soffice\.bin -- gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
-')
+/usr/bin/gcj-dbtool-4.1		--	gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
+/usr/bin/gij-4.1		--	gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
+/usr/lib/openoffice/program/soffice.bin -- gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
 
 ifdef(`distro_gentoo',`
 /usr/lib32/openoffice/program/[^/]+\.bin -- gen_context(system_u:object_r:unconfined_execmem_exec_t,s0)
