From: =?UTF-8?q?Mika=20Pfl=C3=BCger?= <debian@mikapflueger.de>
Date: Sun, 4 Mar 2012 02:06:32 +0100
Subject: Spamassassin policy adjustments

---
 policy/modules/services/milter.fc       |    2 ++
 policy/modules/services/milter.te       |    8 ++++++++
 policy/modules/services/postfix.te      |    5 +++++
 policy/modules/services/spamassassin.if |   20 ++++++++++++++++++++
 policy/modules/services/spamassassin.te |   10 ++++++++--
 5 files changed, 43 insertions(+), 2 deletions(-)

diff --git a/policy/modules/services/milter.fc b/policy/modules/services/milter.fc
index 55a3e2f..e7166ab 100644
--- a/policy/modules/services/milter.fc
+++ b/policy/modules/services/milter.fc
@@ -8,6 +8,8 @@
 /var/run/milter-greylist(/.*)?		gen_context(system_u:object_r:greylist_milter_data_t,s0)
 /var/run/milter-greylist\.pid	--	gen_context(system_u:object_r:greylist_milter_data_t,s0)
 /var/run/spamass-milter(/.*)?		gen_context(system_u:object_r:spamass_milter_data_t,s0)
+/var/run/spamass(/.*)?			gen_context(system_u:object_r:spamass_milter_data_t,s0)
 /var/run/spamass-milter\.pid	--	gen_context(system_u:object_r:spamass_milter_data_t,s0)
 
 /var/spool/milter-regex(/.*)?		gen_context(system_u:object_r:regex_milter_data_t,s0)
+/var/spool/postfix/spamass(/.*)? gen_context(system_u:object_r:spamass_milter_data_t,s0)
diff --git a/policy/modules/services/milter.te b/policy/modules/services/milter.te
index 47e3612..ab29bcd 100644
--- a/policy/modules/services/milter.te
+++ b/policy/modules/services/milter.te
@@ -20,6 +20,10 @@ milter_template(spamass)
 type spamass_milter_state_t;
 files_type(spamass_milter_state_t)
 
+files_pid_file(spamass_milter_data_t)
+files_pid_filetrans(spamass_milter_t, spamass_milter_data_t, { file sock_file })
+allow spamass_milter_t spamass_milter_data_t:{ file sock_file } manage_file_perms;
+
 ########################################
 #
 # milter-greylist local policy
@@ -94,3 +98,7 @@ mta_send_mail(spamass_milter_t)
 optional_policy(`
 	spamassassin_domtrans_client(spamass_milter_t)
 ')
+
+optional_policy(`
+	postfix_search_spool(spamass_milter_t)
+')
diff --git a/policy/modules/services/postfix.te b/policy/modules/services/postfix.te
index 46f7fc5..d165a03 100644
--- a/policy/modules/services/postfix.te
+++ b/policy/modules/services/postfix.te
@@ -638,3 +638,8 @@ mta_delete_spool(postfix_virtual_t)
 # For reading spamassasin
 mta_read_config(postfix_virtual_t)
 mta_manage_spool(postfix_virtual_t)
+
+# for talking to spamass-milter
+optional_policy(`
+	spamassassin_connect_unix_sock(postfix_smtpd_t)
+')
diff --git a/policy/modules/services/spamassassin.if b/policy/modules/services/spamassassin.if
index c954f31..c8a2f83 100644
--- a/policy/modules/services/spamassassin.if
+++ b/policy/modules/services/spamassassin.if
@@ -225,3 +225,23 @@ interface(`spamassassin_dontaudit_getattr_spamd_tmp_sockets',`
 
 	dontaudit $1 spamd_tmp_t:sock_file getattr;
 ')
+
+########################################
+## <summary>
+##	Connect to spamd via unix socket
+## </summary>
+## <param name="domain">
+##      <summary>
+##	Domain to connect
+##      </summary>
+## </param>
+#
+interface(`spamassassin_connect_unix_sock',`
+	gen_require(`
+		type spamd_t, spamd_var_run_t;
+	')
+
+	allow $1 spamd_var_run_t:dir search_dir_perms;
+	allow $1 spamd_var_run_t:sock_file write;
+	allow $1 spamd_t:unix_stream_socket connectto;
+')
diff --git a/policy/modules/services/spamassassin.te b/policy/modules/services/spamassassin.te
index ec1eb1e..58c4188 100644
--- a/policy/modules/services/spamassassin.te
+++ b/policy/modules/services/spamassassin.te
@@ -43,6 +43,7 @@ typealias spamc_t alias { user_spamc_t staff_spamc_t sysadm_spamc_t };
 typealias spamc_t alias { auditadm_spamc_t secadm_spamc_t };
 application_domain(spamc_t, spamc_exec_t)
 ubac_constrained(spamc_t)
+role system_r types spamc_t;
 
 type spamc_tmp_t;
 typealias spamc_tmp_t alias { user_spamc_tmp_t staff_spamc_tmp_t sysadm_spamc_tmp_t };
@@ -52,7 +53,8 @@ ubac_constrained(spamc_tmp_t)
 
 type spamd_t;
 type spamd_exec_t;
-init_daemon_domain(spamd_t, spamd_exec_t)
+init_daemon_domain(spamd_t,spamd_exec_t)
+can_exec(spamd_t,spamc_exec_t)
 
 type spamd_spool_t;
 files_type(spamd_spool_t)
@@ -66,6 +68,7 @@ files_type(spamd_var_lib_t)
 
 type spamd_var_run_t;
 files_pid_file(spamd_var_run_t)
+manage_sock_files_pattern(spamd_t,spamd_var_run_t,spamd_var_run_t)
 
 ##############################
 #
@@ -205,6 +208,7 @@ allow spamc_t self:unix_dgram_socket sendto;
 allow spamc_t self:unix_stream_socket connectto;
 allow spamc_t self:tcp_socket create_stream_socket_perms;
 allow spamc_t self:udp_socket create_socket_perms;
+allow spamc_t self:netlink_route_socket { read write bind create getattr nlmsg_read };
 
 manage_dirs_pattern(spamc_t, spamc_tmp_t, spamc_tmp_t)
 manage_files_pattern(spamc_t, spamc_tmp_t, spamc_tmp_t)
@@ -286,7 +290,7 @@ optional_policy(`
 # setuids to the user running spamc.  Comment this if you are not
 # using this ability.
 
-allow spamd_t self:capability { setuid setgid dac_override sys_tty_config };
+allow spamd_t self:capability { kill setgid setuid dac_override sys_tty_config };
 dontaudit spamd_t self:capability sys_tty_config;
 allow spamd_t self:process ~{ ptrace setcurrent setexec setfscreate setrlimit execmem execstack execheap };
 allow spamd_t self:fd use;
@@ -333,6 +337,7 @@ corenet_tcp_sendrecv_all_ports(spamd_t)
 corenet_udp_sendrecv_all_ports(spamd_t)
 corenet_tcp_bind_generic_node(spamd_t)
 corenet_tcp_bind_spamd_port(spamd_t)
+corenet_tcp_connect_spamd_port(spamd_t)
 corenet_tcp_connect_razor_port(spamd_t)
 corenet_tcp_connect_smtp_port(spamd_t)
 corenet_sendrecv_razor_client_packets(spamd_t)
@@ -421,6 +426,7 @@ optional_policy(`
 
 optional_policy(`
 	postfix_read_config(spamd_t)
+	postfix_search_spool(spamd_t)
 ')
 
 optional_policy(`
