From: =?UTF-8?q?Mika=20Pfl=C3=BCger?= <debian@mikapflueger.de>
Date: Mon, 27 Feb 2012 02:06:37 +0100
Subject: Debian specific changes for init_t

---
 policy/modules/kernel/filesystem.if |   18 ++++++++++++++++++
 policy/modules/system/init.te       |   31 ++++++++++++++++++++++++-------
 2 files changed, 42 insertions(+), 7 deletions(-)

diff --git a/policy/modules/kernel/filesystem.if b/policy/modules/kernel/filesystem.if
index 97fcdac..fdb524b 100644
--- a/policy/modules/kernel/filesystem.if
+++ b/policy/modules/kernel/filesystem.if
@@ -4064,6 +4064,24 @@ interface(`fs_dontaudit_rw_tmpfs_files',`
 
 ########################################
 ## <summary>
+##     Allow reading tmpfs files
+## </summary>
+## <param name="domain">
+##     <summary>
+##     Domain to read files
+##     </summary>
+## </param>
+#
+interface(`fs_allow_tmpfs_file_read',`
+	gen_require(`
+		type tmpfs_t;
+	')
+
+	allow $1 tmpfs_t:file read;
+')
+
+########################################
+## <summary>
 ##	Create, read, write, and delete
 ##	auto moutpoints.
 ## </summary>
diff --git a/policy/modules/system/init.te b/policy/modules/system/init.te
index 62deed5..7dd6ee6 100644
--- a/policy/modules/system/init.te
+++ b/policy/modules/system/init.te
@@ -408,12 +408,18 @@ userdom_read_user_home_content_files(initrc_t)
 # started from init should be placed in their own domain.
 userdom_use_user_terminals(initrc_t)
 
+# seed udev /dev
+dev_create_generic_dirs(initrc_t)
+
 ifdef(`distro_debian',`
-	dev_setattr_generic_dirs(initrc_t)
 	# to be able to create /dev/xconsole
 	dev_create_generic_pipes(initrc_t)
 
-	fs_tmpfs_filetrans(initrc_t, initrc_var_run_t, dir)
+	# for /etc/network/run/ifstate
+	sysnet_manage_config(initrc_t)
+	fs_tmpfs_filetrans(initrc_t,initrc_var_run_t,dir)
+	allow initrc_t initrc_var_run_t:dir manage_dir_perms;
+	allow initrc_t initrc_var_run_t:lnk_file manage_lnk_file_perms;
 
 	# for storing state under /dev/shm
 	fs_setattr_tmpfs_dirs(initrc_t)
@@ -421,6 +427,21 @@ ifdef(`distro_debian',`
 	storage_tmpfs_filetrans_fixed_disk(initrc_t)
 
 	files_setattr_etc_dirs(initrc_t)
+
+        selinux_get_fs_mount(init_t)
+
+        # for /lib/init/rw/.ramfs
+        fs_tmpfs_filetrans(initrc_t,initrc_state_t,file)
+
+        # for progress_state which is created by the initramfs
+        fs_allow_tmpfs_file_read(initrc_t)
+
+        # /etc/network/if-up.d/mountnfs wants to mkdir
+        # /var/run/network/mountnfs as a poor mans lock
+        allow initrc_t var_run_t:dir create;
+
+	# for lsb_release which calls apt-cache
+	apt_read_cache(initrc_t)
 ')
 
 ifdef(`distro_gentoo',`
@@ -430,13 +451,11 @@ ifdef(`distro_gentoo',`
 	allow initrc_t self:process setfscreate;
 	dev_create_null_dev(initrc_t)
 	dev_create_zero_dev(initrc_t)
-	dev_create_generic_dirs(initrc_t)
 	term_create_console_dev(initrc_t)
 
 	# unfortunately /sbin/rc does stupid tricks
 	# with /dev/.rcboot to decide if we are in
 	# early init
-	dev_create_generic_dirs(initrc_t)
 	dev_delete_generic_dirs(initrc_t)
 
 	# allow bootmisc to create /var/lock/.keep.
@@ -738,6 +757,7 @@ optional_policy(`
 
 optional_policy(`
 	postfix_list_spool(initrc_t)
+	postfix_read_config(initrc_t)
 ')
 
 optional_policy(`
@@ -847,9 +867,6 @@ optional_policy(`
 ')
 
 optional_policy(`
-	# Set device ownerships/modes.
-	xserver_setattr_console_pipes(initrc_t)
-
 	# init script wants to check if it needs to update windowmanagerlist
 	xserver_read_xdm_rw_config(initrc_t)
 ')
